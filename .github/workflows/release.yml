name: Release

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build:
    name: Build ${{ matrix.os }}-${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - os: linux
            arch: amd64
            ext: ""
          - os: linux
            arch: arm64
            ext: ""
          - os: darwin
            arch: amd64
            ext: ""
          - os: darwin
            arch: arm64
            ext: ""
          - os: windows
            arch: amd64
            ext: ".exe"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Get version
        id: version
        run: |
          # Read version from VERSION file (single source of truth)
          VERSION=$(cat VERSION | tr -d '\n')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Build binary
        env:
          GOOS: ${{ matrix.os }}
          GOARCH: ${{ matrix.arch }}
          CGO_ENABLED: 0
        run: |
          go build -ldflags="-s -w -X main.Version=${{ steps.version.outputs.version }}" \
            -o hfdownloader_${{ matrix.os }}_${{ matrix.arch }}_${{ steps.version.outputs.version }}${{ matrix.ext }} \
            ./cmd/hfdownloader

      - name: Compress binary (Unix)
        if: matrix.os != 'windows'
        run: |
          tar -czvf hfdownloader_${{ matrix.os }}_${{ matrix.arch }}_${{ steps.version.outputs.version }}.tar.gz \
            hfdownloader_${{ matrix.os }}_${{ matrix.arch }}_${{ steps.version.outputs.version }}

      - name: Compress binary (Windows)
        if: matrix.os == 'windows'
        run: |
          zip hfdownloader_${{ matrix.os }}_${{ matrix.arch }}_${{ steps.version.outputs.version }}.zip \
            hfdownloader_${{ matrix.os }}_${{ matrix.arch }}_${{ steps.version.outputs.version }}.exe

      - name: Upload release asset (Unix)
        if: matrix.os != 'windows'
        uses: softprops/action-gh-release@v1
        with:
          files: hfdownloader_${{ matrix.os }}_${{ matrix.arch }}_${{ steps.version.outputs.version }}.tar.gz

      - name: Upload release asset (Windows)
        if: matrix.os == 'windows'
        uses: softprops/action-gh-release@v1
        with:
          files: hfdownloader_${{ matrix.os }}_${{ matrix.arch }}_${{ steps.version.outputs.version }}.zip

  checksums:
    name: Generate checksums
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true
        continue-on-error: true

      - name: Checkout
        uses: actions/checkout@v4

      - name: Get version
        id: version
        run: |
          VERSION=$(cat VERSION | tr -d '\n')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Download release assets
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          mkdir -p release-files
          gh release download ${{ github.ref_name }} -D release-files -R ${{ github.repository }}

      - name: Generate checksums
        run: |
          cd release-files
          sha256sum * > checksums_${{ steps.version.outputs.version }}.txt
          cat checksums_${{ steps.version.outputs.version }}.txt

      - name: Upload checksums
        uses: softprops/action-gh-release@v1
        with:
          files: release-files/checksums_${{ steps.version.outputs.version }}.txt
